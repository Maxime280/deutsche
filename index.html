<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Deutsche ‚Äî Jeu de Cartes</title>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0c1118;--surface:#141c2b;--surface2:#1c2840;--border:#2d3f60;
  --gold:#c9a84c;--gold-l:#f0d080;--gold-d:#7a5e1a;
  --red:#c0392b;--green:#27ae60;--green-l:#2ecc71;
  --muted:#6a7a9a;--text:#e2d8c8;--card-bg:#fdf8ee;--card-border:#c8a870;
}
body{background:var(--bg);color:var(--text);font-family:Georgia,'Times New Roman',serif;min-height:100vh;
  background-image:radial-gradient(ellipse at 15% 15%,rgba(201,168,76,.06) 0%,transparent 55%),
  radial-gradient(ellipse at 85% 85%,rgba(192,57,43,.04) 0%,transparent 55%);}
.screen{display:none;min-height:100vh}.screen.active{display:flex}
#sLobby{flex-direction:column;align-items:center;justify-content:center;padding:2rem;gap:1.8rem}
.logo{text-align:center}
.suits{font-size:1.8rem;color:var(--gold);letter-spacing:.4em;margin-bottom:.3rem}
h1{font-size:clamp(2.8rem,9vw,5.5rem);font-weight:900;letter-spacing:.18em;color:var(--gold);line-height:1}
.tagline{color:var(--muted);font-style:italic;font-size:1rem;letter-spacing:.1em;margin-top:.3rem}
.box{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:2rem;width:100%;max-width:400px;box-shadow:0 24px 64px rgba(0,0,0,.6)}
.box h2{color:var(--gold);letter-spacing:.1em;margin-bottom:1rem;text-align:center;font-size:1.2rem}
.tabs{display:flex;border-radius:8px;overflow:hidden;border:1px solid var(--border);margin-bottom:1.4rem}
.tab{flex:1;padding:.55rem;background:var(--surface2);border:none;color:var(--muted);cursor:pointer;font-size:.78rem;letter-spacing:.07em;transition:all .2s}
.tab.on{background:var(--gold-d);color:var(--gold-l)}
label{display:block;font-size:.82rem;color:var(--muted);font-style:italic;margin-bottom:.35rem}
input[type=text]{width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:.65rem 1rem;color:var(--text);font-size:1rem;outline:none;transition:border-color .2s;margin-bottom:.9rem;font-family:inherit}
input[type=text]:focus{border-color:var(--gold)}
input.code-input{text-align:center;letter-spacing:.3em;font-size:1.3rem;text-transform:uppercase}
.btn{width:100%;padding:.8rem;border:none;border-radius:8px;font-size:.88rem;letter-spacing:.1em;cursor:pointer;font-weight:700;transition:all .2s;font-family:inherit}
.btn-gold{background:linear-gradient(135deg,var(--gold-d),var(--gold));color:#1a0e00}
.btn-gold:hover{transform:translateY(-1px);box-shadow:0 6px 20px rgba(201,168,76,.3)}
.btn-out{background:transparent;border:1px solid var(--border);color:var(--muted);margin-top:.5rem}
.btn-out:hover{border-color:var(--gold);color:var(--gold)}
.btn-sm{width:auto;padding:.4rem 1rem;font-size:.75rem;margin-bottom:.5rem}
.err{color:#e74c3c;font-size:.85rem;font-style:italic;margin-bottom:.5rem;text-align:center;min-height:1.4em}
.info-box{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:1rem 1.2rem;font-size:.85rem;color:var(--muted);text-align:center;line-height:1.7;max-width:400px;width:100%}
.info-box strong{color:var(--gold)}
#sWait{flex-direction:column;align-items:center;justify-content:center;padding:2rem}
.room-code{font-size:2.4rem;color:var(--gold);letter-spacing:.4em;text-align:center;margin:.6rem 0}
.players{display:flex;flex-direction:column;gap:.5rem;margin:1.2rem 0}
.pslot{background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:.65rem 1rem;display:flex;align-items:center;gap:.7rem;font-size:.95rem}
.pslot.on{border-color:var(--green)}.pslot.off{opacity:.5;font-style:italic;color:var(--muted)}
.dot{width:9px;height:9px;border-radius:50%;background:var(--green);animation:pulse 1.5s infinite}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.5;transform:scale(.8)}}
.sbar{position:fixed;top:0;left:0;right:0;background:var(--surface);border-bottom:1px solid var(--border);padding:.4rem 1rem;display:flex;align-items:center;justify-content:space-between;font-size:.8rem;z-index:50}
.turn-tag{font-size:.7rem;letter-spacing:.07em}
.turn-tag.mine{color:var(--green-l)}.turn-tag.theirs{color:var(--muted)}
.smsg{font-style:italic;color:var(--gold);flex:1;text-align:center;font-size:.82rem}
.dcount{font-size:.7rem;color:var(--muted)}
#sGame{flex-direction:column}
.board{display:grid;grid-template-rows:auto 1fr auto;height:100vh;padding:3.2rem .6rem .6rem;gap:.4rem;max-width:860px;margin:0 auto;width:100%}
.opp-area,.my-area{display:flex;flex-direction:column;align-items:center;gap:.4rem}
.cards-row{display:flex;gap:.45rem;justify-content:center;flex-wrap:wrap}
.name-tag{font-size:.68rem;color:var(--muted);letter-spacing:.1em;background:var(--surface);border:1px solid var(--border);padding:.18rem .7rem;border-radius:20px;transition:all .3s}
.name-tag.active{border-color:var(--gold);color:var(--gold)}.name-tag.mine{border-color:var(--green);color:var(--green-l)}
.center-area{display:flex;align-items:center;justify-content:center;gap:2rem}
.pile-zone{display:flex;flex-direction:column;align-items:center;gap:.35rem}
.pile-label{font-size:.6rem;letter-spacing:.12em;color:var(--muted)}
.pile-slot{width:72px;height:104px;border-radius:8px;border:2px dashed var(--border);display:flex;align-items:center;justify-content:center;position:relative;transition:all .2s}
.pile-slot.click{cursor:pointer}.pile-slot.click:hover{border-color:var(--gold);transform:scale(1.05);box-shadow:0 4px 16px rgba(201,168,76,.25)}
.pile-empty{font-size:.62rem;color:var(--muted);font-style:italic;text-align:center;padding:4px}
.pile-count{position:absolute;top:-7px;right:-7px;background:var(--gold);color:#1a0e00;font-size:.6rem;font-weight:700;padding:2px 5px;border-radius:10px}
.card{width:72px;height:104px;border-radius:9px;border:2px solid var(--card-border);background:var(--card-bg);display:flex;align-items:center;justify-content:center;position:relative;transition:all .2s;user-select:none;flex-shrink:0;box-shadow:2px 3px 10px rgba(0,0,0,.5)}
.card.click{cursor:pointer}.card.click:hover{transform:translateY(-5px);box-shadow:2px 8px 20px rgba(0,0,0,.6)}
.card.sel{transform:translateY(-10px);border-color:var(--gold);box-shadow:0 10px 28px rgba(201,168,76,.45)}
.card.hi{border-color:var(--green);box-shadow:0 0 14px rgba(39,174,96,.6);animation:ggreen 1s infinite alternate}
.card.dim{opacity:.35}.card.mini{width:50px;height:72px}
@keyframes ggreen{from{box-shadow:0 0 8px rgba(39,174,96,.4)}to{box-shadow:0 0 18px rgba(39,174,96,.8)}}
.card-back{width:100%;height:100%;border-radius:7px;background:repeating-linear-gradient(45deg,#1a2a4a 0,#1a2a4a 2px,#0d1830 2px,#0d1830 9px);display:flex;align-items:center;justify-content:center;font-size:1.4rem}
.card-face{width:100%;height:100%;display:flex;flex-direction:column;padding:3px;border-radius:7px;overflow:hidden}
.card-face.r{color:#c0392b}.card-face.b{color:#1a1a2e}
.cn{display:flex;flex-direction:column;align-items:center;line-height:1}
.cn.top{align-self:flex-start}.cn.bot{align-self:flex-end;transform:rotate(180deg)}
.cv{font-size:.88rem;font-weight:700;line-height:1}
.cs{font-size:.65rem;line-height:1}.cc{flex:1;display:flex;align-items:center;justify-content:center;font-size:1.6rem}
.card.mini .cv{font-size:.65rem}.card.mini .cs{font-size:.5rem}.card.mini .cc{font-size:1.1rem}
.clabel{position:absolute;bottom:3px;left:0;right:0;text-align:center;font-size:.5rem;color:rgba(100,120,180,.7)}
.abar{display:flex;flex-wrap:wrap;gap:.5rem;justify-content:center;margin-top:.4rem}
.abtn{padding:.45rem 1.1rem;border:1px solid var(--border);border-radius:20px;background:var(--surface);color:var(--text);font-size:.68rem;letter-spacing:.07em;cursor:pointer;transition:all .2s;font-family:inherit}
.abtn:hover{border-color:var(--gold);color:var(--gold);background:rgba(201,168,76,.08)}
.abtn.ok{border-color:var(--green);color:var(--green-l)}.abtn.danger{border-color:var(--red);color:var(--red)}
.dbtn{padding:.55rem 1.4rem;border-radius:24px;border:none;background:linear-gradient(135deg,#7a0000,#c0392b);color:#ffeaea;font-size:.85rem;font-weight:700;letter-spacing:.12em;cursor:pointer;animation:gred 2s infinite;font-family:inherit}
@keyframes gred{0%,100%{box-shadow:0 0 10px rgba(192,57,43,.5)}50%{box-shadow:0 0 22px rgba(192,57,43,.9)}}
.ov{position:fixed;inset:0;background:rgba(0,0,0,.88);display:none;align-items:center;justify-content:center;z-index:100;backdrop-filter:blur(4px)}
.ov.show{display:flex}
.ovbox{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:1.8rem;max-width:380px;width:92%;text-align:center;box-shadow:0 24px 64px rgba(0,0,0,.7)}
.ovbox h3{color:var(--gold);font-size:1rem;letter-spacing:.1em;margin-bottom:.5rem}
.ovbox p{color:var(--muted);font-size:.88rem;font-style:italic;margin-bottom:.9rem}
.ovcards{display:flex;justify-content:center;margin:1rem 0;gap:.4rem;flex-wrap:wrap}
.ovbtns{display:flex;flex-direction:column;gap:.5rem;margin-top:.5rem}
.ovrow{display:flex;gap:1.5rem;justify-content:center;flex-wrap:wrap;margin:1rem 0;align-items:flex-start}
.ovrow-col{display:flex;flex-direction:column;align-items:center;gap:.3rem}
.toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:var(--surface);border:1px solid var(--gold);border-radius:20px;padding:.55rem 1.4rem;font-size:.75rem;color:var(--gold);letter-spacing:.07em;z-index:200;white-space:nowrap;pointer-events:none;box-shadow:0 4px 20px rgba(0,0,0,.5);opacity:0;transition:opacity .3s}
.toast.show{opacity:1}
#sEnd{flex-direction:column;align-items:center;justify-content:center;padding:2rem}
.score-row{display:flex;justify-content:space-between;align-items:center;background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:.75rem 1.1rem;font-size:1rem;margin-bottom:.3rem}
.pts{font-size:1.3rem;color:var(--gold);font-weight:700}
.wtag{font-size:.62rem;background:var(--green);color:#002200;padding:2px 7px;border-radius:10px;margin-left:.5rem}
.hand-rev{display:flex;gap:.35rem;justify-content:center;flex-wrap:wrap;margin:.6rem 0}
@media(max-width:480px){
  .card{width:58px;height:85px}.card.mini{width:42px;height:60px}
  .pile-slot{width:58px;height:85px}.center-area{gap:1.2rem}
  .cv{font-size:.75rem}.cc{font-size:1.3rem}
}
</style>
</head>
<body>

<!-- LOBBY -->
<div class="screen active" id="sLobby">
  <div class="logo">
    <div class="suits">‚ô† ‚ô• ‚ô¶ ‚ô£</div>
    <h1>DEUTSCHE</h1>
    <p class="tagline">Le jeu de cartes ‚Äî en ligne</p>
  </div>
  <div class="box">
    <div class="tabs">
      <button class="tab on" id="tabCreate" onclick="switchTab('create')">Cr√©er une partie</button>
      <button class="tab" id="tabJoin" onclick="switchTab('join')">Rejoindre</button>
    </div>
    <div id="panelCreate">
      <label>Votre pr√©nom</label>
      <input type="text" id="nameC" placeholder="Ex: Marie" maxlength="20" onkeydown="if(event.key==='Enter')createGame()">
      <button class="btn btn-gold" onclick="createGame()">Cr√©er la partie ‚ñ∂</button>
    </div>
    <div id="panelJoin" style="display:none">
      <label>Votre pr√©nom</label>
      <input type="text" id="nameJ" placeholder="Ex: Lucas" maxlength="20">
      <label>Code de la partie (4 lettres)</label>
      <input type="text" id="codeJ" class="code-input" placeholder="ABCD" maxlength="4" onkeydown="if(event.key==='Enter')joinGame()">
      <button class="btn btn-gold" onclick="joinGame()">Rejoindre ‚ñ∂</button>
    </div>
    <div class="err" id="lobbyErr"></div>
  </div>
  <div class="info-box">
    <strong>Comment jouer √† distance ?</strong><br><br>
    Cr√©ez une partie ‚Üí partagez le <strong>code √† 4 lettres</strong>.<br>
    Votre amie le saisit pour rejoindre. C'est tout !
  </div>
</div>

<!-- WAITING -->
<div class="screen" id="sWait">
  <div class="box">
    <h2>Salle d'attente</h2>
    <p style="color:var(--muted);font-style:italic;font-size:.88rem;text-align:center;margin-bottom:.5rem">Partagez ce code √† votre amie :</p>
    <div class="room-code" id="dispCode">‚Äî</div>
    <div style="text-align:center;margin-bottom:.8rem">
      <button class="btn btn-gold btn-sm" onclick="copyCode()">üìã Copier le code</button>
    </div>
    <div class="players" id="playersList"></div>
    <div id="startArea"></div>
    <button class="btn btn-out" onclick="leaveGame()">Quitter</button>
  </div>
</div>

<!-- GAME -->
<div class="screen" id="sGame">
  <div class="sbar">
    <span class="turn-tag" id="turnTag">‚Äî</span>
    <span class="smsg" id="statusMsg">‚Ä¶</span>
    <span class="dcount" id="deckCount">üÇ† 52</span>
  </div>
  <div class="board">
    <div class="opp-area">
      <div class="name-tag" id="oppTag">Adversaire</div>
      <div class="cards-row" id="oppCards"></div>
    </div>
    <div class="center-area">
      <div class="pile-zone">
        <div class="pile-label">PIOCHE</div>
        <div class="pile-slot" id="deckPile" onclick="drawDeck()">
          <div class="pile-empty">Vide</div>
          <span class="pile-count" id="deckBadge">0</span>
        </div>
      </div>
      <div class="pile-zone">
        <div class="pile-label">D√âFAUSSE</div>
        <div class="pile-slot" id="discardPile" onclick="drawDiscard()">
          <div class="pile-empty">Vide</div>
        </div>
      </div>
    </div>
    <div class="my-area">
      <div class="cards-row" id="myCards"></div>
      <div class="name-tag" id="myTag">Vous</div>
      <div class="abar" id="actionBar"></div>
    </div>
  </div>
</div>

<!-- END -->
<div class="screen" id="sEnd">
  <div class="box" style="max-width:480px">
    <h2>Fin de la manche !</h2>
    <div id="endContent"></div>
    <button class="btn btn-gold" onclick="restartGame()" style="margin-top:1.5rem">Rejouer</button>
    <button class="btn btn-out" onclick="leaveGame()">Quitter</button>
  </div>
</div>

<!-- OVERLAYS -->
<div class="ov" id="ovPeek"><div class="ovbox">
  <h3 id="peekTitle">Votre carte</h3><p id="peekDesc">M√©morisez-la !</p>
  <div class="ovcards" id="peekCard"></div>
  <button class="btn btn-gold" onclick="closePeek()">M√©moris√© ‚úì</button>
</div></div>

<div class="ov" id="ovDrawn"><div class="ovbox">
  <h3 id="drawnTitle">Carte pioch√©e</h3>
  <div class="ovcards" id="drawnCard"></div>
  <div class="ovbtns" id="drawnActions"></div>
</div></div>

<div class="ov" id="ovSwap"><div class="ovbox">
  <h3>Choisissez la carte √† remplacer</h3><p>La carte choisie sera d√©fauss√©e.</p>
  <div class="ovcards" id="swapCards"></div>
  <button class="abtn" onclick="closeOv('ovSwap');showOv('ovDrawn')">‚Üê Retour</button>
</div></div>

<div class="ov" id="ovDouble"><div class="ovbox">
  <h3>Double d√©fausse !</h3><p>Choisissez la carte de m√™me valeur.</p>
  <div class="ovcards" id="doubleCards"></div>
  <button class="abtn" onclick="closeOv('ovDouble');showOv('ovDrawn')">‚Üê Retour</button>
</div></div>

<div class="ov" id="ovJack"><div class="ovbox">
  <h3>Valet ‚ôû ‚Äî Regardez une carte</h3><p>Choisissez une de vos cartes.</p>
  <div class="ovcards" id="jackCards"></div>
</div></div>

<div class="ov" id="ovJackReveal"><div class="ovbox">
  <h3>Votre carte</h3><p>M√©morisez-la !</p>
  <div class="ovcards" id="jackRevealCard"></div>
  <button class="btn btn-gold" onclick="closeJackReveal()">M√©moris√© ‚úì</button>
</div></div>

<div class="ov" id="ovQueen"><div class="ovbox">
  <h3>Dame ‚ôõ ‚Äî √âchange secret</h3><p>Choisissez votre carte et une carte adverse.</p>
  <div class="ovrow">
    <div class="ovrow-col"><div class="pile-label">VOTRE CARTE</div><div class="ovcards" id="queenMy"></div></div>
    <div class="ovrow-col"><div class="pile-label" id="queenOppLbl">ADVERSAIRE</div><div class="ovcards" id="queenOpp"></div></div>
  </div>
  <p id="queenHint" style="color:var(--gold);font-size:.82rem;min-height:1.2em"></p>
</div></div>

<div class="ov" id="ovReactive"><div class="ovbox">
  <h3 id="reactTitle">D√©fausse r√©active !</h3><p id="reactDesc">Vous pouvez d√©fausser une carte de m√™me valeur.</p>
  <div class="ovcards" id="reactCards"></div>
  <button class="abtn danger" onclick="closeOv('ovReactive')">Ignorer</button>
</div></div>

<div class="toast" id="toast"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BACKEND: Firebase Realtime Database (REST API)
// Base de donn√©es publique gratuite ‚Äî fonctionne
// depuis n'importe quel navigateur sans CORS issue
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// IMPORTANT: Remplacez DB_URL par votre propre URL Firebase
// Instruction: firebase.google.com ‚Üí cr√©er projet gratuit ‚Üí
// Realtime Database ‚Üí cr√©er DB ‚Üí copier l'URL ici
// R√®gles √† mettre: { "rules": { ".read": true, ".write": true } }
const DB_URL = "https://deutsche-280-default-rtdb.europe-west1.firebasedatabase.app";

async function fbGet(path) {
  try {
    const r = await fetch(`${DB_URL}/${path}.json`);
    if (!r.ok) return null;
    return await r.json();
  } catch(e) { return null; }
}

async function fbSet(path, data) {
  try {
    const r = await fetch(`${DB_URL}/${path}.json`, {
      method: "PUT",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(data)
    });
    return r.ok;
  } catch(e) { return false; }
}

async function loadRoom() {
  if (!G.roomCode) return null;
  return await fbGet(`rooms/${G.roomCode}`);
}

async function saveRoom(room) {
  if (!G.roomCode) return;
  G.room = room;
  await fbSet(`rooms/${G.roomCode}`, room);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// JEU
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SUITS=["‚ô•","‚ô¶","‚ô†","‚ô£"],VALS=["A","2","3","4","5","6","7","8","9","10","J","Q","K"];
function pts(c){if(!c)return 0;if(c.v==="A")return 1;if(c.v==="J")return 11;if(c.v==="Q")return 12;if(c.v==="K")return(c.s==="‚ô•"||c.s==="‚ô¶")?0:13;return parseInt(c.v);}
function isRed(c){return c&&(c.s==="‚ô•"||c.s==="‚ô¶")}
function makeDeck(){const d=[];for(const s of SUITS)for(const v of VALS)d.push({s,v,id:v+s});return shuffle(d);}
function shuffle(a){const b=[...a];for(let i=b.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[b[i],b[j]]=[b[j],b[i]];}return b;}
function genCode(){const c="ABCDEFGHJKLMNPQRSTUVWXYZ";return Array.from({length:4},()=>c[Math.floor(Math.random()*c.length)]).join("");}
function opp(id){return id==="p0"?"p1":"p0"}

let G={myId:null,myName:"",roomCode:null,room:null,drawn:null,drawnFromDisc:false,pollTimer:null,lastHash:"",lastDiscTop:null,queenMyIdx:null,queenOppIdx:null,jackCb:null,peekIdx:null,peekAfter:null};

function startPoll(){
  if(G.pollTimer)clearInterval(G.pollTimer);
  G.pollTimer=setInterval(async()=>{
    const r=await loadRoom();if(!r)return;
    const h=JSON.stringify(r);if(h===G.lastHash)return;
    G.lastHash=h;G.room=r;onUpdate(r);
  },1500);
}
function stopPoll(){if(G.pollTimer){clearInterval(G.pollTimer);G.pollTimer=null;}}

function show(id){document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));document.getElementById(id).classList.add("active");}
function showOv(id){document.getElementById(id).classList.add("show");}
function closeOv(id){document.getElementById(id).classList.remove("show");}
function closeAllOv(){document.querySelectorAll(".ov").forEach(o=>o.classList.remove("show"));}
let toastT=null;
function toast(msg,dur=2800){const el=document.getElementById("toast");el.textContent=msg;el.classList.add("show");if(toastT)clearTimeout(toastT);toastT=setTimeout(()=>el.classList.remove("show"),dur);}
function errLobby(msg){document.getElementById("lobbyErr").textContent=msg;}
function switchTab(t){document.getElementById("panelCreate").style.display=t==="create"?"block":"none";document.getElementById("panelJoin").style.display=t==="join"?"block":"none";document.getElementById("tabCreate").className="tab"+(t==="create"?" on":"");document.getElementById("tabJoin").className="tab"+(t==="join"?" on":"");document.getElementById("lobbyErr").textContent="";}

async function createGame(){
  const name=document.getElementById("nameC").value.trim();
  if(!name){errLobby("Entrez votre pr√©nom");return;}
  errLobby("Cr√©ation en cours‚Ä¶");
  const code=genCode();
  const room={code,phase:"waiting",players:{p0:{name},p1:null},deck:makeDeck(),hands:{p0:[],p1:[]},discard:[],currentTurn:"p0",deutscheCaller:null,peeksLeft:{p0:2,p1:2},createdAt:Date.now()};
  G.myId="p0";G.myName=name;G.roomCode=code;
  const ok=await fbSet(`rooms/${code}`,room);
  if(!ok){errLobby("Erreur de connexion. V√©rifiez votre internet et que le DB_URL est configur√©.");G.roomCode=null;return;}
  G.room=room;
  document.getElementById("dispCode").textContent=code;
  updateWaiting(room);show("sWait");errLobby("");startPoll();
}

async function joinGame(){
  const name=document.getElementById("nameJ").value.trim();
  const code=document.getElementById("codeJ").value.trim().toUpperCase();
  if(!name){errLobby("Entrez votre pr√©nom");return;}
  if(code.length!==4){errLobby("Code √† 4 lettres svp");return;}
  errLobby("Connexion en cours‚Ä¶");
  G.roomCode=code;
  const room=await loadRoom();
  if(!room){errLobby("Code introuvable. V√©rifiez le code.");G.roomCode=null;return;}
  if(room.players.p1){errLobby("Partie d√©j√† pleine !");G.roomCode=null;return;}
  room.players.p1={name};
  await fbSet(`rooms/${code}`,room);
  G.myId="p1";G.myName=name;G.room=room;
  document.getElementById("dispCode").textContent=code;
  updateWaiting(room);show("sWait");errLobby("");startPoll();
}

function copyCode(){
  navigator.clipboard.writeText(G.roomCode).then(()=>toast("Code copi√© ! Envoyez-le √† votre amie üíå",3000))
  .catch(()=>prompt("Votre code (√† envoyer √† votre amie) :",G.roomCode));
}

function updateWaiting(room){
  const list=document.getElementById("playersList");list.innerHTML="";
  ["p0","p1"].forEach(pid=>{
    const p=room.players[pid];
    const d=document.createElement("div");d.className="pslot "+(p?"on":"off");
    d.innerHTML=p?`<div class="dot"></div>${p.name}${pid===G.myId?" (Vous)":""}`:`<span>En attente d'un joueur‚Ä¶</span>`;
    list.appendChild(d);
  });
  const area=document.getElementById("startArea");area.innerHTML="";
  if(G.myId==="p0"&&room.players.p1){
    const b=document.createElement("button");b.className="btn btn-gold";b.style.marginBottom=".5rem";b.textContent="Commencer la partie ‚ñ∂";b.onclick=startGame;area.appendChild(b);
  }else if(G.myId==="p1"&&room.players.p1){
    area.innerHTML=`<p style="color:var(--green);font-style:italic;font-size:.88rem;text-align:center;margin-bottom:.5rem">‚úì Connect√© ‚Äî en attente de l'h√¥te</p>`;
  }
}

async function startGame(){
  const r=await loadRoom();if(!r||!r.players.p1)return;
  const deck=[...r.deck];r.hands.p0=deck.splice(0,4);r.hands.p1=deck.splice(0,4);r.deck=deck;
  r.phase="memorize";r.peeksLeft={p0:2,p1:2};await saveRoom(r);
}

function onUpdate(room){
  const scr=document.querySelector(".screen.active")?.id;
  if(room.phase==="waiting"){if(scr!=="sWait")show("sWait");updateWaiting(room);return;}
  if(["memorize","playing","last_round"].includes(room.phase)){if(scr!=="sGame")show("sGame");renderBoard(room);checkReactive(room);return;}
  if(room.phase==="ended"){stopPoll();showEnd(room);}
}

function renderBoard(room){
  const me=G.myId,op=opp(me),myHand=room.hands[me]||[],oppHand=room.hands[op]||[];
  const isMy=room.currentTurn===me,phase=room.phase;
  const myN=room.players[me]?.name||"Vous",opN=room.players[op]?.name||"Adversaire";
  document.getElementById("myTag").textContent=myN;document.getElementById("oppTag").textContent=opN;
  document.getElementById("myTag").className="name-tag"+(isMy?" active mine":"");
  document.getElementById("oppTag").className="name-tag"+(!isMy?" active":"");
  const tt=document.getElementById("turnTag"),sm=document.getElementById("statusMsg");
  if(phase==="memorize"){tt.className="turn-tag mine";tt.textContent="üëÅ M√©morisation";sm.textContent=`M√©morisez ${room.peeksLeft[me]} carte${room.peeksLeft[me]>1?"s":""}`;}
  else{tt.className="turn-tag "+(isMy?"mine":"theirs");tt.textContent=isMy?"‚ñ∂ Votre tour":`‚è≥ Tour de ${opN}`;sm.textContent=phase==="last_round"?`‚ö† Dernier tour !`:isMy?"Piochez une carte":`${opN} joue‚Ä¶`;}
  document.getElementById("deckCount").textContent=`üÇ† ${room.deck.length}`;
  const dp=document.getElementById("deckPile");dp.innerHTML=`<span class="pile-count">${room.deck.length}</span>`;
  if(room.deck.length>0){dp.insertBefore(mkCard(null,true),dp.firstChild);dp.className="pile-slot"+(isMy&&!G.drawn&&phase!=="memorize"?" click":"");}
  else{dp.insertAdjacentHTML("afterbegin","<div class='pile-empty'>Vide</div>");dp.className="pile-slot";}
  const dsp=document.getElementById("discardPile");dsp.innerHTML="";
  const top=room.discard.length>0?room.discard[room.discard.length-1]:null;
  if(top){dsp.appendChild(mkCard(top,false));dsp.className="pile-slot"+(isMy&&!G.drawn&&phase!=="memorize"?" click":"");}
  else{dsp.innerHTML="<div class='pile-empty'>Vide</div>";dsp.className="pile-slot";}
  const oc=document.getElementById("oppCards");oc.innerHTML="";oppHand.forEach(()=>oc.appendChild(mkCard(null,true)));
  const mc=document.getElementById("myCards");mc.innerHTML="";
  myHand.forEach((c,i)=>{
    const el=mkCard(c,true);const lbl=document.createElement("span");lbl.className="clabel";lbl.textContent=i+1;el.appendChild(lbl);
    if(phase==="memorize"&&room.peeksLeft[me]>0){el.classList.add("click");el.onclick=()=>doPeek(i,room);}
    mc.appendChild(el);
  });
  const ab=document.getElementById("actionBar");ab.innerHTML="";
  if((phase==="playing"||phase==="last_round")&&isMy&&!G.drawn){
    const db=document.createElement("button");db.className="dbtn";db.textContent="DEUTSCHE !";db.onclick=callDeutsche;ab.appendChild(db);
  }
}

function mkCard(c,faceDown,mini=false){
  const d=document.createElement("div");d.className="card"+(mini?" mini":"");
  if(faceDown||!c){d.innerHTML=`<div class="card-back">üÇ†</div>`;}
  else{const r=isRed(c);d.innerHTML=`<div class="card-face ${r?"r":"b"}"><div class="cn top"><span class="cv">${c.v}</span><span class="cs">${c.s}</span></div><div class="cc">${c.s}</div><div class="cn bot"><span class="cv">${c.v}</span><span class="cs">${c.s}</span></div></div>`;}
  return d;
}

function doPeek(idx,room){
  const card=room.hands[G.myId][idx],after=room.peeksLeft[G.myId]-1;
  document.getElementById("peekTitle").textContent=`Carte ${idx+1}`;
  document.getElementById("peekDesc").textContent=after>0?`Il vous reste ${after} regard${after>1?"s":""}. M√©morisez !`:"Derni√®re carte ‚Äî m√©morisez bien !";
  const pc=document.getElementById("peekCard");pc.innerHTML="";pc.appendChild(mkCard(card,false));
  G.peekIdx=idx;G.peekAfter=after;showOv("ovPeek");
}

async function closePeek(){
  closeOv("ovPeek");const r=await loadRoom();if(!r)return;
  r.peeksLeft[G.myId]=G.peekAfter;
  if(r.peeksLeft.p0<=0&&r.peeksLeft.p1<=0)r.phase="playing";
  await saveRoom(r);
}

async function drawDeck(){
  if(G.drawn)return;const r=await loadRoom();if(!r)return;
  if(r.currentTurn!==G.myId){toast("Ce n'est pas votre tour");return;}
  if(r.phase!=="playing"&&r.phase!=="last_round")return;
  if(r.deck.length===0){if(r.discard.length<=1){toast("Plus de cartes !");return;}const top=r.discard.pop();r.deck=shuffle(r.discard);r.discard=[top];toast("Pioche reconstitu√©e !");}
  const card=r.deck.shift();await saveRoom(r);G.drawn=card;G.drawnFromDisc=false;showDrawnOv(r,card);
}

async function drawDiscard(){
  if(G.drawn)return;const r=await loadRoom();if(!r)return;
  if(r.currentTurn!==G.myId){toast("Ce n'est pas votre tour");return;}
  if(r.phase!=="playing"&&r.phase!=="last_round")return;
  if(r.discard.length===0){toast("D√©fausse vide");return;}
  const card=r.discard[r.discard.length-1];G.drawn=card;G.drawnFromDisc=true;showDrawnOv(r,card);
}

function showDrawnOv(r,card){
  document.getElementById("drawnTitle").textContent=G.drawnFromDisc?"Carte de la d√©fausse":"Carte pioch√©e";
  const dc=document.getElementById("drawnCard");dc.innerHTML="";dc.appendChild(mkCard(card,false));
  const canDouble=r.hands[G.myId].some(c=>c.v===card.v);
  const da=document.getElementById("drawnActions");da.innerHTML="";
  if(!G.drawnFromDisc){const b=document.createElement("button");b.className="abtn";b.textContent="D√©fausser cette carte";b.onclick=()=>doDiscardDrawn(card);da.appendChild(b);}
  const b2=document.createElement("button");b2.className="abtn";b2.textContent="√âchanger avec ma main";b2.onclick=()=>{closeOv("ovDrawn");showSwapOv(r,card);};da.appendChild(b2);
  if(canDouble){const b3=document.createElement("button");b3.className="abtn ok";b3.textContent="Double d√©fausse (m√™me valeur)";b3.onclick=()=>{closeOv("ovDrawn");showDoubleOv(r,card);};da.appendChild(b3);}
  if(G.drawnFromDisc){const bc=document.createElement("button");bc.className="abtn danger";bc.textContent="Annuler";bc.onclick=()=>{G.drawn=null;closeOv("ovDrawn");};da.appendChild(bc);}
  showOv("ovDrawn");
}

async function doDiscardDrawn(card){closeOv("ovDrawn");const r=await loadRoom();if(!r)return;r.discard.push(card);G.drawn=null;await handleSpecial(r,card);}

function showSwapOv(r,card){
  const sc=document.getElementById("swapCards");sc.innerHTML="";
  r.hands[G.myId].forEach((c,i)=>{const el=mkCard(c,true);el.classList.add("click");const lbl=document.createElement("span");lbl.className="clabel";lbl.textContent=i+1;el.appendChild(lbl);el.onclick=()=>doSwap(i,card,r);sc.appendChild(el);});
  showOv("ovSwap");
}

async function doSwap(idx,drawnCard,r){
  closeOv("ovSwap");const rr=await loadRoom();if(!rr)return;
  if(G.drawnFromDisc)rr.discard.pop();const old=rr.hands[G.myId][idx];rr.discard.push(old);rr.hands[G.myId][idx]=drawnCard;G.drawn=null;await handleSpecial(rr,old);
}

function showDoubleOv(r,card){
  const dc=document.getElementById("doubleCards");dc.innerHTML="";
  r.hands[G.myId].forEach((c,i)=>{const el=mkCard(c,true);const lbl=document.createElement("span");lbl.className="clabel";lbl.textContent=i+1;el.appendChild(lbl);if(c.v===card.v){el.classList.add("click","hi");el.onclick=()=>doDouble(i,card,r);}else el.classList.add("dim");dc.appendChild(el);});
  showOv("ovDouble");
}

async function doDouble(idx,drawnCard,r){
  closeOv("ovDouble");const rr=await loadRoom();if(!rr)return;
  if(G.drawnFromDisc)rr.discard.pop();rr.discard.push(drawnCard);rr.discard.push(rr.hands[G.myId][idx]);rr.hands[G.myId].splice(idx,1);G.drawn=null;await endTurn(rr);
}

async function handleSpecial(r,card){
  if(card.v==="J"){await saveRoom(r);showJackOv(r);}
  else if(card.v==="Q"){await saveRoom(r);showQueenOv(r);}
  else await endTurn(r);
}

function showJackOv(r){
  const jc=document.getElementById("jackCards");jc.innerHTML="";
  r.hands[G.myId].forEach((c,i)=>{const el=mkCard(c,true);el.classList.add("click");const lbl=document.createElement("span");lbl.className="clabel";lbl.textContent=i+1;el.appendChild(lbl);el.onclick=()=>{closeOv("ovJack");const rc=document.getElementById("jackRevealCard");rc.innerHTML="";rc.appendChild(mkCard(c,false));showOv("ovJackReveal");G.jackCb=async()=>{const rr=await loadRoom();if(rr)await endTurn(rr);};};jc.appendChild(el);});
  showOv("ovJack");
}

async function closeJackReveal(){closeOv("ovJackReveal");if(G.jackCb){await G.jackCb();G.jackCb=null;}}

function showQueenOv(r){
  G.queenMyIdx=null;G.queenOppIdx=null;const op=opp(G.myId);
  document.getElementById("queenOppLbl").textContent=r.players[op]?.name||"Adversaire";
  document.getElementById("queenHint").textContent="Choisissez une carte de chaque c√¥t√©.";
  const qm=document.getElementById("queenMy");qm.innerHTML="";
  r.hands[G.myId].forEach((c,i)=>{const el=mkCard(c,true);el.classList.add("click");const lbl=document.createElement("span");lbl.className="clabel";lbl.textContent=i+1;el.appendChild(lbl);el.onclick=()=>{qm.querySelectorAll(".card").forEach(e=>e.classList.remove("sel"));el.classList.add("sel");G.queenMyIdx=i;checkQueen(r);};qm.appendChild(el);});
  const qo=document.getElementById("queenOpp");qo.innerHTML="";
  r.hands[op].forEach((c,i)=>{const el=mkCard(c,true);el.classList.add("click");const lbl=document.createElement("span");lbl.className="clabel";lbl.textContent=i+1;el.appendChild(lbl);el.onclick=()=>{qo.querySelectorAll(".card").forEach(e=>e.classList.remove("sel"));el.classList.add("sel");G.queenOppIdx=i;checkQueen(r);};qo.appendChild(el);});
  showOv("ovQueen");
}

async function checkQueen(r){
  const hint=document.getElementById("queenHint");
  if(G.queenMyIdx===null){hint.textContent="üëà Choisissez votre carte";return;}
  if(G.queenOppIdx===null){hint.textContent="üëâ Choisissez la carte adverse";return;}
  closeOv("ovQueen");const rr=await loadRoom();if(!rr)return;
  const op=opp(G.myId);const tmp=rr.hands[G.myId][G.queenMyIdx];rr.hands[G.myId][G.queenMyIdx]=rr.hands[op][G.queenOppIdx];rr.hands[op][G.queenOppIdx]=tmp;
  toast("√âchange secret effectu√© !");await endTurn(rr);
}

function checkReactive(room){
  if(room.currentTurn===G.myId)return;if(room.discard.length===0)return;
  const top=room.discard[room.discard.length-1];if(top.id===G.lastDiscTop)return;
  G.lastDiscTop=top.id;const myHand=room.hands[G.myId];
  const matches=myHand.reduce((a,c,i)=>{if(c.v===top.v)a.push(i);return a;},[]);
  if(matches.length===0)return;if(document.querySelector(".ov.show"))return;
  document.getElementById("reactTitle").textContent=`D√©fausse r√©active ‚Äî ${top.v}${top.s}`;
  document.getElementById("reactDesc").textContent=`Vous pouvez d√©fausser un(e) ${top.v} maintenant !`;
  const rc=document.getElementById("reactCards");rc.innerHTML="";
  myHand.forEach((c,i)=>{const el=mkCard(c,true);const lbl=document.createElement("span");lbl.className="clabel";lbl.textContent=i+1;el.appendChild(lbl);if(matches.includes(i)){el.classList.add("click","hi");el.onclick=()=>doReactive(i,top);}else el.classList.add("dim");rc.appendChild(el);});
  showOv("ovReactive");
}

async function doReactive(idx,topCard){
  closeOv("ovReactive");const r=await loadRoom();if(!r)return;
  const myCard=r.hands[G.myId][idx];
  if(myCard.v!==topCard.v){if(r.deck.length>0){const pen=r.deck.shift();r.hands[G.myId].push(pen);await saveRoom(r);}toast("‚ùå Mauvaise carte ! +1 p√©nalit√©");return;}
  r.hands[G.myId].splice(idx,1);r.discard.push(myCard);await saveRoom(r);toast(`‚úì D√©fauss√© ${myCard.v}${myCard.s}`);checkEnd(r);
}

async function callDeutsche(){
  const r=await loadRoom();if(!r)return;
  if(r.currentTurn!==G.myId){toast("Ce n'est pas votre tour !");return;}
  if(r.phase!=="playing")return;
  if(!confirm("Appeler DEUTSCHE ? Ce sera le dernier tour pour l'adversaire !"))return;
  r.phase="last_round";r.deutscheCaller=G.myId;toast("DEUTSCHE ! Dernier tour !",3000);await endTurn(r);
}

async function endTurn(r){
  G.drawn=null;closeAllOv();if(checkEnd(r))return;
  const op=opp(G.myId);
  if(r.phase==="last_round"){if(r.currentTurn===r.deutscheCaller)r.currentTurn=op;else{r.phase="ended";await saveRoom(r);showEnd(r);return;}}
  else r.currentTurn=r.currentTurn==="p0"?"p1":"p0";
  await saveRoom(r);
}

function checkEnd(r){
  if((r.hands.p0||[]).length===0||(r.hands.p1||[]).length===0){r.phase="ended";saveRoom(r);stopPoll();showEnd(r);return true;}return false;
}

function showEnd(room){
  stopPoll();show("sEnd");
  const me=G.myId,op=opp(me),mh=room.hands[me]||[],oh=room.hands[op]||[];
  const mp=mh.reduce((s,c)=>s+pts(c),0),op2=oh.reduce((s,c)=>s+pts(c),0);
  const myN=room.players[me]?.name||"Vous",opN=room.players[op]?.name||"Adversaire";
  const myW=mp<op2||(mp===op2&&room.deutscheCaller===op),opW=op2<mp||(mp===op2&&room.deutscheCaller===me);
  function hh(hand){return hand.map(c=>{const r=isRed(c);return`<div class="card mini"><div class="card-face ${r?"r":"b"}"><div class="cn top"><span class="cv">${c.v}</span><span class="cs">${c.s}</span></div><div class="cc">${c.s}</div><div class="cn bot"><span class="cv">${c.v}</span></div></div></div>`;}).join("");}
  document.getElementById("endContent").innerHTML=`
    <div class="score-row"><span>${myN}${myW?' <span class="wtag">üèÜ GAGNANT</span>':''}</span><span class="pts">${mp} pts</span></div>
    <div class="hand-rev">${hh(mh)}</div>
    <div class="score-row" style="margin-top:.5rem"><span>${opN}${opW?' <span class="wtag">üèÜ GAGNANT</span>':''}</span><span class="pts">${op2} pts</span></div>
    <div class="hand-rev">${hh(oh)}</div>
    ${mp===op2&&!myW&&!opW?'<p style="color:var(--gold);text-align:center;margin-top:.8rem">√âgalit√© !</p>':""}
    ${room.deutscheCaller?`<p style="color:var(--muted);font-size:.85rem;font-style:italic;text-align:center;margin-top:.5rem">${room.players[room.deutscheCaller]?.name} avait appel√© Deutsche</p>`:""}`;
}

async function restartGame(){
  if(G.myId!=="p0"){show("sWait");startPoll();return;}
  const r=await loadRoom();if(!r)return;
  const nr={code:r.code,phase:"waiting",players:r.players,deck:makeDeck(),hands:{p0:[],p1:[]},discard:[],currentTurn:"p0",deutscheCaller:null,peeksLeft:{p0:2,p1:2},createdAt:Date.now()};
  await saveRoom(nr);G.drawn=null;G.lastDiscTop=null;show("sWait");startPoll();
}

function leaveGame(){
  stopPoll();
  G={myId:null,myName:"",roomCode:null,room:null,drawn:null,drawnFromDisc:false,pollTimer:null,lastHash:"",lastDiscTop:null,queenMyIdx:null,queenOppIdx:null,jackCb:null,peekIdx:null,peekAfter:null};
  closeAllOv();document.getElementById("nameC").value="";document.getElementById("nameJ").value="";document.getElementById("codeJ").value="";document.getElementById("lobbyErr").textContent="";
  show("sLobby");
}
</script>
</body>
</html>
